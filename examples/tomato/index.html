<!DOCTYPE html>
<html>
    <head>
        <title>Tomato animation at 9 fps</title>
        <style>

body {
    width: 480px;
    margin: 2em auto;
    font-family: Univers, ui-sans-serif, sans-serif;
    background-color: #222;
}

canvas {
    border-radius: 8px;
}

button {
    font-size: 1rem;
    padding: 0.5rem;
    border-radius: 8px;
    background-color: #f8f9f0;
    border: 0;
}

ul {
    text-align: center;
    padding: 0;
    list-style-type: none;
}

ul li {
    display: inline;
    margin: 0 0.2rem;
}

        </style>
        <script type="module">

import { assoc, imagePromise, mod, range } from "../../lib/util.js";
import { Clock } from "../../lib/clock.js";

play(Promise.all(
    range(1, 18).map(i => imagePromise(`img/tomato${i.toString().padStart(2, "0")}.png`))
));

async function play(imagesPromise) {

    const canvas = document.querySelector("canvas");
    const context = canvas.getContext("2d");
    const clock = Clock.create();
    const fps = 9;

    let loop = "idle";
    let nextLoop = [];
    let loopOffset = 0;

    const images = await imagesPromise;
    const loops = {
        idle: images.slice(0, 4),
        blink: images.slice(5, 9),
        speak: images.slice(9),
    };

    function draw(image) {
        canvas.width = image.naturalWidth;
        canvas.height = image.naturalHeight;
        context.drawImage(image, 0, 0);
    }

    draw(images[0]);

    clock.scheduler.ratio(frame => {
        const i = mod(frame - loopOffset, loops[loop].length);
        if (nextLoop.length > 0 || loop !== "idle") {
            if (i === 0) {
                loop = nextLoop.shift() ?? "idle";
                loopOffset = frame;
            }
        }
        draw(loops[loop][i]);
    }, fps);

    const buttons = assoc(
        document.querySelectorAll("button"),
        button => {
            button.addEventListener("click", () => { pushed(button.name, button); });
            return [button.name, button];
        }
    );

    function pushed(name, button) {
        ({
            stop: () => {
                clock.stop();
                button.disabled = true;
                buttons.get("start").disabled = false;
                loop = "idle";
                nextLoop = [];
            },
            start: () => {
                clock.start();
                button.disabled = true;
                buttons.get("stop").disabled = false;
            },
            blink: () => { nextLoop.push("blink"); },
            speak: () => { nextLoop.push("speak"); },
        })[name]();
    }

}

        </script>
    </head>
    <body>
        <canvas></canvas>
        <ul>
            <li><button type="button" name="stop" disabled>Stop</button></li>
            <li><button type="button" name="start">Start</button></li>
            <li><button type="button" name="blink">Blink</button></li>
            <li><button type="button" name="speak">Speak</button></li>
        </ul>
    </body>
</html>
