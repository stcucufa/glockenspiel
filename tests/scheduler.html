<!DOCTYPE html>
<html>
    <head>
        <title>Scheduler</title>
        <script type="module">

import { test } from "./test.js";
import { Scheduler, Inclusive } from "../lib/scheduler.js";

function update(scheduler, from, to, inclusive) {
    for (const [f, t, i] of scheduler.schedule(from, to, inclusive)) {
        if (isNaN(i)) {
            f(t, from, to);
        } else {
            f(i, t, from, to);
        }
    }
}

test("Create a new scheduler", t => {
    const scheduler = Scheduler.create();
    t.ok(scheduler);
});

test("Add an single event with at(f, t)", t => {
    const scheduler = Scheduler.create();
    let happened = false;
    scheduler.at(() => { happened = true; }, 10);
    t.equal(happened, false, "Event does not happen when it is added");
    update(scheduler, 0, 20);
    t.equal(happened, true, "Event happens during the update");
});

test("Add repeating events with ratio(f, n)", t => {
    const scheduler = Scheduler.create();
    const frames = [];
    // Animate at 9fps but refresh at 25fps (every 40ms)
    scheduler.ratio(i => frames.push(i), 9);
    update(scheduler, 0, 40, Inclusive);
    t.equal(frames, [0], "First frame");
    update(scheduler, 40, 80);
    t.equal(frames, [0], "No new frame");
    update(scheduler, 80, 120);
    t.equal(frames, [0, 1], "New frame");
    update(scheduler, 120, 160);
    t.equal(frames, [0, 1], "Wait for next frame");
    update(scheduler, 160, 200);
    t.equal(frames, [0, 1], "Wait a bit more for next frame");
    update(scheduler, 200, 240);
    t.equal(frames, [0, 1, 2], "Got a new frame");
    update(scheduler, 240, 999.999);
    t.equal(frames, [0, 1, 2, 3, 4, 5, 6, 7, 8], "9 frames within 1s");
    update(scheduler, 999.999, 1000);
    t.equal(frames, [0, 1, 2, 3, 4, 5, 6, 7, 8, 9], "10th frame at exactly 1s");
});

test("Add repeating events with ratio(f, n, d)", t => {
    const scheduler = Scheduler.create();
    const beats = [];
    // Play at 72 bpm
    scheduler.ratio(i => beats.push(i), 72, 60000);
    update(scheduler, 0, 1000, Inclusive);
    t.equal(beats, [0, 1], "Two beats in first second");
    update(scheduler, 1000, 2000);
    t.equal(beats, [0, 1, 2], "One beat in first second");
    update(scheduler, 2000, 2500);
    t.equal(beats, [0, 1, 2, 3], "Fourth beat at exactly 2.5s");
});

test("Add repeating events with ratio(f, n, d, t)", t => {
    const scheduler = Scheduler.create();
    const beats = [];
    // Play at 72 bpm
    scheduler.ratio(i => beats.push(i), 72, 60000, 500);
    update(scheduler, 0, 1000, Inclusive);
    t.equal(beats, [0], "First beat in first second");
    update(scheduler, 1000, 2000);
    t.equal(beats, [0, 1], "Second beat in second second");
    update(scheduler, 2000, 3000);
    t.equal(beats, [0, 1, 2, 3], "Fourth beat at exactly 3s (with 500ms offset)");
});

test("Update: ]from, to]", t => {
    const scheduler = Scheduler.create();
    let atZero = false;
    let atOne = false;
    scheduler.at(() => { atZero = true; }, 0);
    scheduler.at(() => { atOne = true; }, 1);
    update(scheduler, 0, 2);
    t.equal(atZero, false, "0 has already happened");
    t.equal(atOne, true, "1 has happened during update");
});

test("Update: [from, to]", t => {
    const scheduler = Scheduler.create();
    let atZero = false;
    let atOne = false;
    scheduler.at(() => { atZero = true; }, 0);
    scheduler.at(() => { atOne = true; }, 1);
    update(scheduler, 0, 2, Inclusive);
    t.equal(atZero, true, "0 has happened during update");
    t.equal(atOne, true, "1 has happened during update");
});

test("Update: ]t, t] (nothing happens)", t => {
    const scheduler = Scheduler.create();
    let first = false;
    let second = false;
    scheduler.at(() => { first = true; }, 0);
    scheduler.at(() => { second = true; }, 0);
    update(scheduler, 0, 0);
    t.equal(first, false, "First event has not happened");
    t.equal(second, false, "Second event has not happened");
});

test("Update: [t, t] (events happens)", t => {
    const scheduler = Scheduler.create();
    let first = false;
    let second = false;
    scheduler.at(() => { first = true; }, 0);
    scheduler.at(() => { second = true; }, 0);
    update(scheduler, 0, 0, Inclusive);
    t.equal(first, true, "First event has happened");
    t.equal(second, true, "Second event has happened");
});

test("Update: ]from, to], backward", t => {
    const scheduler = Scheduler.create();
    let atTwo = false;
    let atOne = false;
    scheduler.at(() => { atTwo = true; }, 2);
    scheduler.at(() => { atOne = true; }, 1);
    update(scheduler, 2, 0);
    t.equal(atTwo, false, "2 has already happened");
    t.equal(atOne, true, "1 has happened during update");
});

test("Update: [from, to], backward", t => {
    const scheduler = Scheduler.create();
    let atTwo = false;
    let atOne = false;
    scheduler.at(() => { atTwo = true; }, 2);
    scheduler.at(() => { atOne = true; }, 1);
    update(scheduler, 2, 0, Inclusive);
    t.equal(atTwo, true, "2 has happened during update");
    t.equal(atOne, true, "1 has happened during update");
});

test("Update: repeat events, starting at zero", t => {
    const scheduler = Scheduler.create();
    let updateTimes = [];
    scheduler.every(updateTime => { updateTimes.push(updateTime); }, 5);
    update(scheduler, 0, 7, Inclusive);
    t.equal(updateTimes, [0, 5], "First round of updates");
    update(scheduler, 7, 14);
    t.equal(updateTimes, [0, 5, 10], "Second round of updates");
    update(scheduler, 14, 21);
    t.equal(updateTimes, [0, 5, 10, 15, 20], "Third round of updates");
});

test("Update: repeat events, starting after zero", t => {
    const scheduler = Scheduler.create();
    let updateTimes = [];
    scheduler.every(updateTime => { updateTimes.push(updateTime); }, 5, 13);
    update(scheduler, 0, 7, Inclusive);
    t.equal(updateTimes, [3], "First round of updates");
    update(scheduler, 7, 14);
    t.equal(updateTimes, [3, 8, 13], "Second round of updates");
    update(scheduler, 14, 21);
    t.equal(updateTimes, [3, 8, 13, 18], "Third round of updates");
});

        </script>
    </head>
    <body>
    </body>
</html>
