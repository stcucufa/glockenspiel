<!DOCTYPE html>
<html>
    <head>
        <title>Clock</title>
        <script type="module">

import { test, skip } from "./test.js";
import { Clock } from "../lib/clock.js";
import { ManualTick } from "../lib/tick.js";

test("Create a new clock", t => {
    const clock = Clock.create();
    t.equal(clock.rate, 1, "default rate");
    t.equal(clock.state, Clock.States.Stopped, "initial state");
    t.ok(clock.tick, "default tick");
    t.ok(clock.scheduler, "default scheduler");
});

test("Create a new clock with extra properties", t => {
    const clock = Clock.create({
        for: "testing",
        rate: 2,
        state: "invalid",
        tick: ManualTick.create()
    });

    t.equal(clock.for, "testing", "custom properties");
    t.equal(clock.rate, 2, "initial rate is overridden");
    t.equal(clock.state, Clock.States.Stopped, "initial state is not overridden");
    t.typeof(clock.tick.advance, "function");
});

test("Clock states", t => {
    const clock = Clock.create();
    clock.start();
    t.equal(clock.state, Clock.States.Running, "start() when stopped");
    clock.stop();
    t.equal(clock.state, Clock.States.Stopped, "stop() when running");
    clock.start();
    clock.pause();
    t.equal(clock.state, Clock.States.Paused, "pause() when running");
    clock.resume();
    t.equal(clock.state, Clock.States.Running, "resume() when paused");
    clock.pause();
    clock.stop();
    t.equal(clock.state, Clock.States.Stopped, "stop() when paused");
    clock.start();
    clock.pause();
    clock.start();
    t.equal(clock.state, Clock.States.Paused, "do not start when paused");
    clock.stop();
    clock.pause();
    t.equal(clock.state, Clock.States.Stopped, "do not pause when stopped");
});

test("Override tick", t => {
    const clock = Clock.create({
        tick: ManualTick.create()
    });
    clock.start();
    t.equal(clock.now, 0, "Clock starts at 0");
    clock.tick.advance(17);
    t.equal(clock.now, 17, "Clock advanced to 17");
    clock.tick.advance(13);
    t.equal(clock.now, 30, "Clock advanced to 30");
});

test("Advance time from clock ticks", t => {
    const clock = Clock.create({
        tick: ManualTick.create()
    });

    const events = [false, false, false];
    for (let i = 0; i < events.length; ++i) {
        clock.scheduler.at(updateTime => { events[i] = updateTime; }, i)
    }

    clock.start();
    clock.tick.advance(1);
    t.equal(events[0], 0, "event happened at 0");
    t.equal(events[1], 1, "event happened at 1");
    t.equal(events[2], false, "event not yet happened at 2");

    clock.tick.advance(1);
    t.equal(events[2], 2, "event happened at 2")
});

test("Advance time manually", t => {
    const clock = Clock.create({
        tick: ManualTick.create()
    });

    const events = [false, false, false];
    for (let i = 0; i < events.length; ++i) {
        clock.scheduler.at(updateTime => { events[i] = updateTime; }, i)
    }

    clock.start();
    clock.advance(2);
    clock.tick.advance(1);
    t.equal(events[0], 0, "event happened at 0");
    t.equal(events[1], 1, "event happened at 1");
    t.equal(events[2], 2, "event happened at 2");
});

skip("Skip time", t => {
    const clock = Clock.create({
        tick: ManualTick.create()
    });

    const events = [false, false, false];
    for (let i = 0; i < events.length; ++i) {
        clock.scheduler.at(updateTime => { events[i] = updateTime; }, i)
    }

    clock.start();
    clock.skip(2);
    clock.tick.advance(1);
    t.equal(events[0], false, "event at 0 was skipped");
    t.equal(events[1], false, "event at 1 was skipped");
    t.equal(events[2], 2, "event happened at 2");
});


        </script>
    </head>
    <body>
    </body>
</html>
